# :pushpin: SUBQUERY

### :bulb: 서브쿼리, Subquery
- **SQL문장에 포함된 또 다를 SQL구문**을 뜻한다
- 메인쿼리(외부쿼리)와 서브쿼리(**내부쿼리**)로 지칭한다
- 서브쿼리는 ()괄호로 묶어서 표현한다

#### 서브쿼리의 종류 : 적용하는 위치에 따른 분류
- 스칼라 서브쿼리 : **SELECT절의 컬럼으로 사용**되는 서브쿼리
- 서브쿼리 : **WHERE의 조건으로 사용**되는 서브쿼리
- 인라인 뷰 : **FROM 절의 조회 테이블로 사용**되는 서브쿼리

#### 서브쿼리의 종류 : 서브쿼리 수행 결과의 형태에 따른 분류
- 단일 행 서브쿼리 : 수행 결과가 **하나의 행**으로 나오는 서브쿼리
- 다중 행 서브쿼리 : 수행 결과가 **여러 행**으로 나오는 서브쿼리
>  단일행, 다중행 서브쿼리는 사용할 수 있는 연산자가 달라진다
- 다중 열 서브쿼리 : 서브쿼리의 결과가 **여러 컬럼(열)**로 나오는 서브쿼리

### :bulb: WITH절
- 인라인 뷰(서브쿼리)에 이름을 붙이는 것
- 임시로 인라인뷰에 대한 **별칭**을 붙여 사용하는 것이다
- 구문 형식
    ```sql
	WITH [별칭] AS (
	  [서브쿼리, 인라인 뷰]
	)

	SELECT (WITH로 설정된 별칭 사용 가능)
    
    ** SELECT를 수행할 때 WITH절과 함께 실행해야한다
    ```

### :bulb: TOP-N 분석 쿼리
- 조회 결과에 **순위**를 매겨 상위 또는 하위 데이터를 찾아내는 것
#### 서브쿼리를 이용한 TOP-N 분석
- 인라인뷰, rownum, ORDER BY, WHERE를 적절히 섞어 구현해야한다
    ```sql
	SELECT * FROM (

	  SELECT rownum rnum, DATA.* FROM ( --순위 매기기

	    --원하는 데이터를 조회하는 쿼리 작성 (WHERE조건 사용 가능)
	    SELECT 코드
	    ORDER BY 정렬 --순위 기준 설정

	  ) DATA

	) R
	WHERE rnum BETWEEN ? AND ? --조회하려는 순위 지정하기
    ```

### :bulb: OVER() 함수
- ORDER BY, GROUP BY를 적용하기 위해 **서브쿼리를 사용하는 상황을 개선**하기 위해 나온 함수
- 구문 형식
    ```sql
	그룹함수() OVER( [PARTITION BY 컬럼] [ORDER BY 컬럼] )

	** 그룹함수로는 집계함수, 분석함수가 사용된다
	  -> count, max, min, sum, avg, rank, dense_rank, row_number, ...

	** PARTIION BY 는 GROUP BY처럼 사용한다

	** ORDER BY 는 정렬할 때 사용한다
    ```
#### OVER()에서 사용하는 분석 함수
- ROW_NUMBER() : 행 번호 생성
- RANK() : 순위 생성
    - 같은 값일 경우 **같은 등수**
    - 같은 등수를 가지는 개수만큼 **다음 순위를 건너뛴다**
    > ex) 1 2 2 2 5 6 6 8
- DENSE_RANK() : 순위 생성
	- 같은 값일 경우 **같은 등수**
	- 같은 등수를 가지는 개수와 상관없이 바로 **다음 순위를 순서대로 지정한다**	
    > ex) 1 2 2 2 3 4 4 5

### :bulb: 다중 행 서브쿼리
- **서브쿼리의 조회 결과가 2건(2행)이상 나오는 서브쿼리**
- 다중 행 전용 연산자만 사용 가능하다
- 단일 행 서브쿼리 연산자( = != < > <= 등등 )는 사용할 수 없다
- 스칼라 서브쿼리로 사용할 수 없다
#### 다중 행 전용 연산자의 종류
- **[IN](https://github.com/thdqudgns/TIL-Today-I-Learned/tree/main/DB/SQL#%EA%B8%B0%ED%83%80-%EC%97%B0%EC%82%B0%EC%9E%90)**
    - 단일 행 연산자로 사용할 때와 사용법이 같다
	- 다중 행 **결과 데이터를 전부 동등비교**(=)한다
	- 각 데이터 비교는 OR로 연결된 것과 같다
- **ANY ( = SOME )**
	- 비교컬럼이 서브쿼리의 결과 중에서 **어떤 값이라도 조건에 만족하면 조회**된다 (OR와 비슷한 동작)
	- column = ANY ( a,b,c ) : a,b,c 중 어떤 값이라도 같다면 조회된다(IN)
	- column < ANY ( a,b,c ) : a,b,c 중 최대값보다 작다면 조회된다
	- column > ANY ( a,b,c ) : a,b,c 중 최소값보다 크다면 조회된다
- **ALL**
	- 비교컬럼이 서브쿼리의 결과 중 **모든 값과 조건에 만족하면 조회**된다 (AND와 비슷한 동작)
	- column = ALL ( a,b,c ) : a,b,c모두와 같으면 조회(비교하는 의미가 없음)
	- column < ALL ( a,b,c ) : a,b,c 중 최소값보다 작다면 조회된다
	- column > ALL ( a,b,c ) : a,b,c 중 최대값보다 크다면 조회된다
- **EXISTS**
	- 서브쿼리와 메인쿼리를 비교하여 **서브쿼리의 조회 결과로 존재하는 행이라면 메인쿼리에서 조회**되도록 만든다

> **IN연산자 vs EXISTS연산자**   
IN연산자를 이용하면 서브쿼리를 수행하고 그 결과값을 직접 메인쿼리에서 비교한 후 결과를 판단한다   
EXSISTS연산자를 이용하면 서브쿼리에 해당하는 데이터가 존재하는지만 판단하고 값을 직접 비교하지는 않는다 -> 중간 결과값을 생성하지 않는다

### :bulb: 집합 연산자
- **두 개의 쿼리**(SELECT)의 결과를 **하나의 집합**으로 만드는 연산자
- SELECT로 조회된 결과를 Result Set(결과 집합)이라고 한다
- 집합 연산자는 2개의 Result Set을 하나의 결과 집합으로 합치는 것
- 각 SELECT 구문의 결과에서 **컬럼의 수, 컬럼의 이름이 같아야 한다**
#### 집합 연산자의 종류
- UNION : 합집합
- UNION ALL : 합집합, 중복 허용
- INTERSECT : 교집합
- MINUS : 차집합

### :bulb: GROUP BY의 확장 구문
#### GROUP BY ROLLUP()
- GROUP BY에 나열된 컬럼들을 뒤에서부터 하나씩 줄여가면서 만든 추가 그룹핑 집계결과를 산출하여 결과집합에 포함시킨다
- 그룹화된 컬럼들의 레벨별 순차 집계를 구한다
#### GROUP BY CUBE()
- ROLLUP과 비슷한 동작을 하지만 레벨에 상관없이 모든 조합 결과를 포함한다
- 컬럼의 나열된 순서에 상관없이 가능한 모든 조합으로 그룹핑한다
> ex) 키워드에 따라 그룹핑하는 단계(컬럼집합)이 달라진다   

GROUP BY -> deptno, job   

GROUP BY ROLLUP   
	-> deptno, job   
	-> deptno   
    -> all   

GROUP BY CUBE   
	-> deptno, job   
	-> deptno   
	-> job   
	-> all   
